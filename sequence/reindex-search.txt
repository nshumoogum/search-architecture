title Reindex Sitewide Search

autonumber

note over Developer: Request made by a developer logging on to\nthe publishing server to trigger a reindex job

Developer->Search Reindex API: Http: POST Reindex job

note over Search Reindex API: Validate a search reindex is not already in progress

Search Reindex API->MongoDB: TCP/IO socket: Retrieve list of job status of in-progress
Search Reindex API->MongoDB: TCP/IO socket: Create new job doc
Search Reindex API->Search API: Http: POST new index

Search API->Elasticsearch: Http: Create new sitewide (new-ONS) search index

Search Reindex API->MongoDB: Update job document with search index name
Search Reindex API-->Search Data Extractor: TCP: Kafka message
Search Reindex API->Developer: Http Successful response

Search Data Extractor->Zebedee: Http: Trigger extraction of search docs

Zebedee->Zebedee Content: I/O: READ JSON files from\ndisc (master directory)
Zebedee->Search Reindex API: Http: PUT Reindex Job, update total_search_documents

Search Reindex API->MongoDB: Update Reindex job - Zebedee task

Zebedee-->Search Data Importer: TCP: Kafka message

Search Data Extractor->Dataset API: Http: GET CMD datasets (meta data endpoint?)
Search Data Extractor->Search Reindex API: Http: PUT Reindex Job, update total_search_documents

Search Reindex API->MongoDB: Update Reindex job - Dataset API task

Search Data Extractor-->Search Data Importer: TCP: Kafka message

Search Data Importer->Elasticsearch: Http: Bulk query to add\ndocs to search index
Search Data Importer->Search Reindex API: Http: Update uploaded document count for reindex job

Search Reindex API->MongoDB: TCP/IO socket: Update job doc

note over Search Reindex API: If uploaded document counts does not match\nthe total document count, skip the following steps 21-24

Search Reindex API->Search API: Http: POST ONS alias to search index

Search API->Elasticsearch: Http: Validate search index document count
Search API->Elasticsearch: Http: Multi-operational request to update aliases

Search Reindex API->MongoDB: TCP/IO socket: Update reindex job state to completed